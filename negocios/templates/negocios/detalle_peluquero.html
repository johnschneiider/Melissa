{% extends 'base.html' %}
{% load widget_tweaks %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
/* Estilos generales mejorados */
.cover-container {
  position: relative;
  width: 100%;
  max-width: 900px;
  margin: auto;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}
.cover-image {
  width: 100%;
  height: 220px;
  object-fit: cover;
  display: block;
}
.edit-cover-icon, .edit-avatar-icon {
  position: absolute;
  bottom: 12px;
  right: 12px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 6px;
  border-radius: 50%;
  font-size: 14px;
  cursor: pointer;
  border: 2px solid white;
  z-index: 2;
}
.profile-picture-wrapper {
  position: relative;
  width: 120px;
  height: 120px;
  margin: -60px auto 20px auto;
  z-index: 3;
}
.profile-picture-wrapper img,
.default-avatar {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #fff;
  background-color: #adb5bd;
  display: flex;
  align-items: center;
  justify-content: center;
}
.profile-container {
  max-width: 900px;
  margin: 30px auto;
  background: #fff;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
}

/* Estilos para el horario */
.horario-container {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 30px;
}

.dia-horario {
  background: white;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.turno-item {
  background: #e9f7ef;
  border-left: 4px solid #28a745;
  padding: 8px 12px;
  margin-bottom: 8px;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
}

.turno-item .bi {
  cursor: pointer;
  color: #dc3545;
}

.festivo {
  background-color: #fff3cd;
  border-left-color: #ffc107;
}

/* Estilos para la visualización de turnos */
.turnos-semana-container {
  margin-top: 30px;
}

.semana-header {
  display: flex;
  margin-bottom: 15px;
}

.dia-header {
  flex: 1;
  text-align: center;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
  margin: 0 5px;
  font-weight: bold;
}

.dia-header.festivo {
  background: #fff3cd;
}

.turnos-grid {
  display: flex;
}

.dia-columna {
  flex: 1;
  margin: 0 5px;
}

.time-slot {
  margin-bottom: 5px;
  padding: 8px;
  border-radius: 4px;
  background: #e9f7ef;
  text-align: center;
}

.time-slot.disabled {
  background: #f8d7da;
  color: #dc3545;
}

.time-slot.festivo {
  background: #fff3cd;
}

/* Selector de días */
.dias-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.dia-selector {
  padding: 8px 15px;
  border-radius: 20px;
  background: #e9ecef;
  cursor: pointer;
  user-select: none;
}

.dia-selector.selected {
  background: #007bff;
  color: white;
}

/* Panel de configuración de horario */
.configurador-horario {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

@media (max-width: 768px) {
  .turnos-grid {
    flex-direction: column;
  }
  .dia-columna {
    margin-bottom: 20px;
  }
}
</style>

<div class="cover-container">
  <div class="cover-wrapper">
    <img src="{% if peluquero.portada %}{{ peluquero.portada.url }}{% else %}https://via.placeholder.com/900x220?text=Portada{% endif %}" class="cover-image">
    <label for="{{ form.portada.id_for_label }}" class="edit-cover-icon">
      <i class="bi bi-pencil-fill"></i>
    </label>
  </div>
</div>

<div class="profile-picture-wrapper">
  {% if peluquero.avatar %}
    <img src="{{ peluquero.avatar.url }}" alt="Foto de perfil">
  {% else %}
    <div class="default-avatar">
      <i class="bi bi-person" style="font-size: 48px; color: white;"></i>
    </div>
  {% endif %}
  <label for="{{ form.avatar.id_for_label }}" class="edit-avatar-icon">
    <i class="bi bi-pencil-fill"></i>
  </label>
</div>

<div class="profile-container">
  <form method="POST" enctype="multipart/form-data" id="peluqueroForm">
    {% csrf_token %}
    
    <!-- Inputs ocultos para avatar y portada -->
    <div style="display: none;">
      {{ form.avatar }}
      {{ form.portada }}
    </div>
    
    <!-- Nombre y descripción -->
    <div class="mb-4">
      <label class="form-label">Nombre del Peluquero</label>
      {{ form.nombre|add_class:"form-control" }}
    </div>
    
    <div class="mb-4">
      <label class="form-label">Descripción</label>
      {{ form.descripcion|add_class:"form-control" }}
    </div>
    
    <!-- Configuración de horario -->
    <div class="horario-container">
      <h4 class="mb-4">Configuración de Horario</h4>
      
      <!-- Selector de días -->
      <div class="dias-selector mb-4">
        <div class="dia-selector selected" data-dia="todos">Todos los días</div>
        {% for dia in dias_semana %}
        <div class="dia-selector" data-dia="{{ dia.nombre|lower }}">
          {{ dia.nombre }}
          {% if dia.festivo %}<span class="badge bg-warning ms-1">Festivo</span>{% endif %}
        </div>
        {% endfor %}
      </div>
      
      <!-- Configurador de horario -->
      <div class="configurador-horario">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Hora de inicio</label>
            <input type="time" class="form-control" id="horaInicio" value="08:00">
          </div>
          <div class="col-md-4">
            <label class="form-label">Hora de fin</label>
            <input type="time" class="form-control" id="horaFin" value="18:00">
          </div>
          <div class="col-md-3">
            <label class="form-label">Duración (minutos)</label>
            <input type="number" class="form-control" id="duracionTurno" min="15" value="30">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button type="button" class="btn btn-primary w-100" id="agregarHorario">
              <i class="bi bi-plus-lg"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Visualización de horarios configurados -->
      <div id="horariosConfigurados" class="mt-4">
        {% for dia in dias_semana %}
        <div class="dia-horario {% if dia.festivo %}festivo{% endif %}" data-dia="{{ dia.nombre }}">
          <h5>
            {{ dia.nombre }}
            {% if dia.festivo %}<span class="badge bg-warning ms-2">Festivo</span>{% endif %}
          </h5>
          <div class="turnos-container">
            {% for turno in dia.turnos %}
            <div class="turno-item">
              <span>{{ turno.inicio }} - {{ turno.fin }} ({{ turno.duracion }} min)</span>
              <i class="bi bi-trash" onclick="eliminarTurno(this)"></i>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
      
      <input type="hidden" name="horario_json" id="horarioJson" value='{{ horario_json }}'>
    </div>
    
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary px-5">Guardar cambios</button>
    </div>
  </form>
  
  <!-- Visualización de Turnos Disponibles -->
    <div class="turnos-semana-container mt-5">
    <h4>Turnos Disponibles</h4>
    
    <div class="semana-header">
      {% for dia in proximos_7_dias %}
        <div class="dia-header {% if dia.festivo %}festivo{% endif %}">
          {{ dia.fecha|date:"D d/m" }}<br>
          {% if dia.festivo %}<span class="badge bg-warning">Festivo</span>{% endif %}
        </div>
      {% endfor %}
    </div>
    
    <div class="turnos-grid">
      {% for dia in proximos_7_dias %}
        <div class="dia-columna">
          {% if dia.turnos %}
            {% for turno in dia.turnos %}
              <!-- Calcular intervalos para este turno -->
              {% with inicio=turno.inicio|time:"H:i" fin=turno.fin|time:"H:i" duracion=turno.duracion %}
                {% for intervalo in turno.intervalos %}
                  <div class="time-slot {% if dia.festivo %}festivo{% endif %}">
                    {{ intervalo.inicio|time:"H:i" }} - {{ intervalo.fin|time:"H:i" }}
                  </div>
                {% endfor %}
              {% endwith %}
            {% endfor %}
          {% else %}
            <div class="alert alert-warning">No hay horario configurado</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elementos del formulario
  const form = document.getElementById('peluqueroForm');
  const horarioJsonInput = document.getElementById('horarioJson');
  
  // Selectores de días
  const diaSelectors = document.querySelectorAll('.dia-selector');
  let diasSeleccionados = ['todos'];
  
  // Configurador de horario
  const horaInicio = document.getElementById('horaInicio');
  const horaFin = document.getElementById('horaFin');
  const duracionTurno = document.getElementById('duracionTurno');
  const agregarHorarioBtn = document.getElementById('agregarHorario');
  
  // Manejar selección de días
  diaSelectors.forEach(selector => {
    selector.addEventListener('click', function() {
      const dia = this.dataset.dia;
      
      if (dia === 'todos') {
        // Seleccionar/deseleccionar todos
        const todosSeleccionado = this.classList.contains('selected');
        diaSelectors.forEach(s => {
          s.classList.toggle('selected', !todosSeleccionado);
          if (s.dataset.dia === 'todos') return;
          s.classList.toggle('selected', !todosSeleccionado);
        });
        diasSeleccionados = todosSeleccionado ? [] : ['todos'];
      } else {
        // Seleccionar día individual
        this.classList.toggle('selected');
        
        // Actualizar lista de días seleccionados
        if (this.classList.contains('selected')) {
          diasSeleccionados.push(dia);
          // Si se selecciona algún día individual, deseleccionar "todos"
          const todos = document.querySelector('.dia-selector[data-dia="todos"]');
          todos.classList.remove('selected');
          diasSeleccionados = diasSeleccionados.filter(d => d !== 'todos');
        } else {
          diasSeleccionados = diasSeleccionados.filter(d => d !== dia);
        }
      }
    });
  });
  
  // Agregar horario
  agregarHorarioBtn.addEventListener('click', function() {
    const inicio = horaInicio.value;
    const fin = horaFin.value;
    const duracion = duracionTurno.value;
    
    if (!inicio || !fin) {
      alert('Por favor ingresa hora de inicio y fin');
      return;
    }
    
    if (inicio >= fin) {
      alert('La hora de inicio debe ser anterior a la hora de fin');
      return;
    }
    
    if (diasSeleccionados.length === 0) {
      alert('Selecciona al menos un día');
      return;
    }
    
    // Agregar turno a los días seleccionados
    const horario = JSON.parse(horarioJsonInput.value || '{}');
    const diasAActualizar = diasSeleccionados.includes('todos') ? 
      ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'] : 
      diasSeleccionados;
    
    diasAActualizar.forEach(dia => {
      const nombreDia = capitalizarDia(dia);
      if (!horario[nombreDia]) horario[nombreDia] = { turnos: [] };
      
      horario[nombreDia].turnos.push({
        inicio: inicio,
        fin: fin,
        duracion: duracion,
        disponible: true
      });
      
      // Actualizar visualización
      actualizarVisualizacionDia(nombreDia, horario[nombreDia].turnos);
    });
    
    horarioJsonInput.value = JSON.stringify(horario);
  });
  
  // Función para capitalizar nombres de días
  function capitalizarDia(dia) {
    const dias = {
      'lunes': 'Lunes',
      'martes': 'Martes',
      'miercoles': 'Miércoles',
      'jueves': 'Jueves',
      'viernes': 'Viernes',
      'sabado': 'Sábado',
      'domingo': 'Domingo'
    };
    return dias[dia] || dia.charAt(0).toUpperCase() + dia.slice(1);
  }
  
  // Función para actualizar visualización de un día
  function actualizarVisualizacionDia(nombreDia, turnos) {
    let container = document.querySelector(`.dia-horario[data-dia="${nombreDia}"] .turnos-container`);
    if (!container) {
      // Crear contenedor si no existe
      const diaContainer = document.createElement('div');
      diaContainer.className = `dia-horario ${nombreDia === 'Domingo' ? 'festivo' : ''}`;
      diaContainer.dataset.dia = nombreDia;
      diaContainer.innerHTML = `
        <h5>
          ${nombreDia}
          ${nombreDia === 'Domingo' ? '<span class="badge bg-warning ms-2">Festivo</span>' : ''}
        </h5>
        <div class="turnos-container"></div>
      `;
      document.getElementById('horariosConfigurados').appendChild(diaContainer);
      container = diaContainer.querySelector('.turnos-container');
    }
    
    // Limpiar y volver a renderizar
    container.innerHTML = '';
    turnos.forEach(turno => {
      const turnoHTML = `
        <div class="turno-item">
          <span>${turno.inicio} - ${turno.fin} (${turno.duracion} min)</span>
          <i class="bi bi-trash" onclick="eliminarTurno(this)"></i>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', turnoHTML);
    });
  }
  
  // Configurar envío del formulario
  form.addEventListener('submit', function(e) {
    const horario = JSON.parse(horarioJsonInput.value || '{}');
    const tieneTurnos = Object.values(horario).some(dia => dia.turnos && dia.turnos.length > 0);
    
    if (!tieneTurnos) {
      e.preventDefault();
      alert('Debes configurar al menos un horario para algún día');
      return false;
    }
  });
});

// Función global para eliminar turno
function eliminarTurno(icon) {
  if (!confirm('¿Eliminar este turno?')) return;
  
  const item = icon.closest('.turno-item');
  const texto = item.querySelector('span').textContent;
  const [horas, duracion] = texto.split(' (');
  const [inicio, fin] = horas.split(' - ');
  const dur = duracion.replace(' min)', '');
  
  const diaContainer = item.closest('.dia-horario');
  const nombreDia = diaContainer.dataset.dia;
  
  // Actualizar JSON
  const horarioJsonInput = document.getElementById('horarioJson');
  const horario = JSON.parse(horarioJsonInput.value || '{}');
  
  if (horario[nombreDia]) {
    horario[nombreDia].turnos = horario[nombreDia].turnos.filter(t => 
      !(t.inicio === inicio && t.fin === fin && t.duracion == dur)
    );
    
    // Si no quedan turnos, eliminar el día
    if (horario[nombreDia].turnos.length === 0) {
      delete horario[nombreDia];
    }
    
    horarioJsonInput.value = JSON.stringify(horario);
  }
  
  // Eliminar visualmente
  item.remove();
  
  // Si no quedan turnos en el día, mostrar mensaje
  if (diaContainer.querySelectorAll('.turno-item').length === 0) {
    diaContainer.querySelector('.turnos-container').innerHTML = '<p>No hay horarios configurados</p>';
  }
}
</script>
{% endblock %}