{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Melissa | Reservas Exclusivas para Peluquerías de Lujo{% endblock %}

{% block content %}


<!-- Hero Section -->
<section class="hero-section-custom d-flex flex-column justify-content-center align-items-center text-center min-vh-100 position-relative p-0" style="padding-top:0;background:var(--color-black-deep);color:var(--color-smoke-white);font-family:var(--font-ui);">
    <div class="hero-bg-gradient position-absolute top-0 start-0 w-100 h-100" style="z-index:0;background:linear-gradient(135deg,var(--color-black-deep) 60%,var(--color-graphite-gray) 100%);"></div>

    <div class="container position-relative" style="z-index:1;">
        <h1 class="fw-bold display-1 mb-4 text-center w-100 mx-auto animated-hero-title" style="font-family: var(--font-ui); color: var(--color-smoke-white); margin-top: 3.5rem;">
            Reserva con tus peluquerias<br />
            <span id="frase-rotativa">o descubre tu favorita</span>
        </h1>

<br><br>
<!-- Buscador principal elevado (responsive) -->
<section class="search-bar-section position-relative w-100 d-flex justify-content-center" style="z-index: 10; margin-top: -30px;">
    <div class="container">
        <!-- Desktop/Tablet: barra extendida -->
        <div class="d-none d-md-flex search-bar-elevated-custom bg-white rounded-pill shadow mx-auto align-items-center justify-content-between px-4 py-2 position-relative" style="max-width: 700px; min-height: 60px;background:var(--color-graphite-gray);color:var(--color-smoke-white);">
            <div class="d-flex flex-column justify-content-center align-items-start flex-grow-1 px-2 position-relative" style="min-width: 160px;">
                <label class="form-label fw-bold text-muted mb-1 ms-1 small" style="font-size: 0.95rem;">Ubicación</label>
                <input type="text" id="ubicacion-autocomplete" class="form-control" placeholder="¿Dónde buscar?" autocomplete="off" />
                <div id="sugerencias-ubicacion" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
                <input type="hidden" id="ubicacion-ciudad" name="ciudad" />
                <input type="hidden" id="ubicacion-barrio" name="barrio" />
                <input type="hidden" id="ubicacion-lat" name="lat" />
                <input type="hidden" id="ubicacion-lon" name="lon" />
            </div>
            <div class="search-separator"></div>
            <div class="d-flex flex-column justify-content-center align-items-start flex-grow-1 px-2 position-relative" style="min-width: 160px;">
                <label class="form-label fw-bold text-muted mb-1 ms-1 small" style="font-size: 0.95rem;">Servicio</label>
                <input type="text" id="servicio-autocomplete" class="form-control" placeholder="¿Qué servicio?" autocomplete="off" />
                <div id="sugerencias-servicio" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
            </div>
            <div class="search-separator"></div>
            <div class="d-flex flex-column justify-content-center align-items-start flex-grow-1 px-2 position-relative" style="min-width: 160px;">
                <label class="form-label fw-bold text-muted mb-1 ms-1 small" style="font-size: 0.95rem;">Negocio</label>
                <input type="text" id="negocio-autocomplete" class="form-control" placeholder="¿Qué peluquería?" autocomplete="off" />
                <div id="sugerencias-negocio" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
            </div>
            <button class="btn btn-pink ms-3 d-flex align-items-center justify-content-center rounded-circle" style="background: #ff3366; color: #fff; width: 44px; height: 44px; box-shadow: 0 2px 8px rgba(255,51,102,0.10); font-size: 1.3rem;" type="button">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <!-- Mobile: barra compacta que abre modal -->
        <div class="d-block d-md-none">
            <div class="search-bar-mobile rounded-pill shadow mx-auto d-flex align-items-center px-3 py-3 justify-content-center w-100" style="max-width: 100%; min-height: 54px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background:var(--color-graphite-gray);color:var(--color-smoke-white);" data-bs-toggle="modal" data-bs-target="#busquedaModal">
                <i class="bi bi-search fs-4 text-muted me-2"></i>
                <span class="text-muted flex-grow-1 text-center" style="font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">¿Qué reserva buscar hoy?</span>
            </div>
        </div>
    </div>
</section>

{% if user.is_authenticated and is_cliente %}
<div class="d-flex justify-content-center mt-4">
    <a href="{% url 'clientes:dashboard' %}" class="btn btn-primary btn-lg px-5 py-3 fw-bold" style="background:var(--color-mint-green);color:var(--color-black-deep);">
        <i class="bi bi-calendar-plus me-2"></i>Reservar ahora
    </a>
</div>
{% endif %}

        <div class="mt-5 mb-4">
            <span class="fw-bold" style="font-size:1.5rem; letter-spacing:1px;color:var(--color-mint-green);font-family:var(--font-ui);">{{ total_reservas|intcomma }}</span>
            <span style="font-size:1.2rem; color:var(--color-champagne-beige);">citas reservadas</span>
        </div>
        <div class="d-flex justify-content-center">
            <a href="{% url 'clientes:proximamente_app' %}" class="btn btn-light border px-4 py-2 rounded-pill fw-bold d-flex align-items-center" style="font-size:1.1rem;background:var(--color-champagne-beige);color:var(--color-black-deep);border:none;">
                Obtener la app <i class="bi bi-qr-code-scan ms-2"></i>
            </a>
        </div>
    </div>
</section>



<!-- Modal búsqueda mobile (adaptado) -->
<div class="modal fade" id="busquedaModal" tabindex="-1" aria-labelledby="busquedaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 p-2" style="background: var(--color-graphite-gray);color:var(--color-smoke-white);">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="busquedaModalLabel">Buscar servicios</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body pt-2">
        <div class="mb-3 position-relative">
          <label class="form-label fw-bold text-muted mb-1 small">Ubicación</label>
          <input type="text" id="ubicacion-autocomplete-mobile" class="form-control" placeholder="¿Qué ciudad o barrio?" autocomplete="off" />
          <div id="sugerencias-ubicacion-mobile" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
          <input type="hidden" id="ubicacion-ciudad-mobile" name="ciudad" />
          <input type="hidden" id="ubicacion-barrio-mobile" name="barrio" />
          <input type="hidden" id="ubicacion-lat-mobile" name="lat" />
          <input type="hidden" id="ubicacion-lon-mobile" name="lon" />
        </div>
        <div class="mb-3 position-relative">
          <label class="form-label fw-bold text-muted mb-1 small">Servicio</label>
          <input type="text" id="servicio-autocomplete-mobile" class="form-control" placeholder="¿Qué servicio buscas?" autocomplete="off" />
          <div id="sugerencias-servicio-mobile" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
        </div>
        <div class="mb-3 position-relative">
          <label class="form-label fw-bold text-muted mb-1 small">Negocio</label>
          <input type="text" id="negocio-autocomplete-mobile" class="form-control" placeholder="¿Qué peluquería?" autocomplete="off" />
          <div id="sugerencias-negocio-mobile" class="list-group position-absolute" style="z-index: 1000; max-width: 350px; min-width: 260px; top: 100%; left: 0; margin-top: 5px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 1px solid #e9ecef; background: white;"></div>
        </div>
        <div class="d-flex justify-content-end mt-4">
          <button class="btn btn-pink d-flex align-items-center justify-content-center rounded-circle" style="background: #ff3366; color: #fff; width: 48px; height: 48px; box-shadow: 0 2px 8px rgba(255,51,102,0.10); font-size: 1.5rem;" type="button">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Características principales -->
<section class="features-section py-5">
    <div class="container">
        <div class="row text-center mb-5">
            <div class="col-lg-8 mx-auto">
                <h2 class="display-5 fw-bold mb-4" style="color:var(--color-smoke-white);font-family:var(--font-ui);">
                    ¿Por qué elegir <span class="text-accent" style="color:var(--color-mint-green);">Melissa</span>?
                </h2>
                <p class="lead mb-5" style="color:var(--color-smoke-white);font-family:var(--font-ui);">
                    La plataforma más avanzada para peluquerías que buscan la excelencia
                </p>
            </div>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="feature-card text-center p-4 h-100" style="background:var(--color-graphite-gray);color:var(--color-smoke-white);border-radius:1rem;">
                    <div class="feature-icon rounded-circle d-inline-flex align-items-center justify-content-center mb-4 icon-inteligente">
                        <i class="bi bi-calendar-check fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-3 feature-title">Gestión Inteligente</h4>
                    <p class="feature-desc">
                        Sistema de reservas automático que optimiza tu agenda y maximiza tus ingresos
                    </p>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="feature-card text-center p-4 h-100" style="background:var(--color-graphite-gray);color:var(--color-smoke-white);border-radius:1rem;">
                    <div class="feature-icon rounded-circle d-inline-flex align-items-center justify-content-center mb-4 icon-premium">
                        <i class="bi bi-star fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-3 feature-title">Experiencia Premium</h4>
                    <p class="feature-desc">
                        Interfaz elegante que refleja la calidad de tu negocio y mejora la satisfacción del cliente
                    </p>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="feature-card text-center p-4 h-100" style="background:var(--color-graphite-gray);color:var(--color-smoke-white);border-radius:1rem;">
                    <div class="feature-icon rounded-circle d-inline-flex align-items-center justify-content-center mb-4 icon-analytics">
                        <i class="bi bi-graph-up fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-3 feature-title">Analytics Avanzados</h4>
                    <p class="feature-desc">
                        Métricas detalladas para tomar decisiones informadas y hacer crecer tu negocio
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- CTA Section -->
<section class="cta-section py-5">
    <div class="container text-center">
        <h2 class="fw-bold mb-4 cta-title">
            ¿Listo para transformar tu peluquería?
        </h2>
        <p class="mb-5 opacity-90 cta-desc">
            Únete a cientos de peluquerías que ya confían en Melissa
        </p>
        {% if not user.is_authenticated %}
            <a href="{% url 'cuentas:registro_unificado' %}" class="btn btn-warning btn-lg px-5 py-3 fw-bold" style="background:var(--color-champagne-beige);color:var(--color-black-deep);border:none;">
                <i class="bi bi-rocket-takeoff me-2"></i>Comenzar Gratis
            </a>
        {% else %}
            {% if is_cliente %}
                <a href="{% url 'clientes:dashboard' %}" class="btn btn-warning btn-lg px-5 py-3 fw-bold" style="background:var(--color-mint-green);color:var(--color-black-deep);border:none;">
                    <i class="bi bi-search me-2"></i>Explorar Negocios
                </a>
            {% elif is_negocio %}
                <a href="{% url 'negocios:crear_negocio' %}" class="btn btn-warning btn-lg px-5 py-3 fw-bold" style="background:var(--color-mint-green);color:var(--color-black-deep);border:none;">
                    <i class="bi bi-plus-circle me-2"></i>Crear mi Negocio
                </a>
            {% endif %}
        {% endif %}
    </div>
</section>

<!-- Hero Section */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
    overflow: hidden;
}

.hero-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%), 
                linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.1) 75%), 
                linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.1) 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    opacity: 0.1;
}

.hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
}

.hero-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
}

.hero-content {
    position: relative;
    z-index: 2;
}

.hero-card {
    position: relative;
    z-index: 2;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
}

/* Search Bar */
.search-bar {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.search-bar::before {
    content: '';
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    bottom: -1px;
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    z-index: -1;
    border-radius: 20px;
    opacity: 0.3;
}

/* Feature Cards */
.feature-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
}

/* CTA Section */
.cta-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    position: relative;
    overflow: hidden;
}

.cta-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%), 
                linear-gradient(-45deg, rgba(255,255,255,0.1) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, rgba(255,255,255,0.1) 75%), 
                linear-gradient(-45deg, transparent 75%, rgba(255,255,255,0.1) 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    opacity: 0.1;
}

.cta-section .container {
    position: relative;
    z-index: 2;
}

/* Responsive */
@media (max-width: 768px) {
    .hero-content h1 {
        font-size: 2.5rem;
    }
    
    .search-bar-elevated {
        display: none !important;
    }
    .search-bar-mobile {
        display: flex !important;
    }
}
@media (min-width: 768px) {
    .search-bar-mobile {
        display: none !important;
    }
}
/* Hover ovalado para labels de la barra de búsqueda */
@media (min-width: 768px) {
    .search-bar-elevated label.form-label {
        transition: background 0.2s, color 0.2s;
        border-radius: 2rem;
        padding: 0.25rem 1.2rem 0.25rem 1.2rem;
        cursor: pointer;
    }
    .search-bar-elevated label.form-label:hover {
        background: #f3f4f6;
        color: #3b82f6;
    }
    .search-bar-elevated .btn-search {
        transition: background 0.2s, box-shadow 0.2s;
    }
    .search-bar-elevated .btn-search:hover {
        background: #d81b60 !important;
        box-shadow: 0 6px 20px rgba(216,27,96,0.18);
    }
}

/* Barra de búsqueda avanzada mejorada */
.search-bar-elevated-custom {
    box-shadow: 0 4px 24px rgba(102, 126, 234, 0.10);
    border: none !important;
    min-height: 44px !important;
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}
.search-bar-elevated-custom .form-label {
    margin-bottom: 0.2rem !important;
    font-size: 0.93rem;
}
.search-bar-elevated-custom .form-control {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    padding: 0.35rem 0.5rem !important;
    font-size: 1rem;
    min-height: 32px !important;
    height: 32px !important;
}
.search-bar-elevated-custom .form-control:focus {
    box-shadow: none !important;
    border: none !important;
}
.search-bar-elevated-custom .vr {
    border-left: 1.5px solid #e0e0e0 !important;
    height: 40px !important;
    margin: 0 0.5rem !important;
    align-self: stretch !important;
}
.search-bar-elevated-custom .d-flex.flex-column {
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
}
.search-bar-elevated-custom input::placeholder {
    color: #b0b0b0;
    font-size: 0.98rem;
}
.search-bar-elevated-custom {
    border-bottom: none !important;
}
.search-bar-mobile {
    box-shadow: 0 4px 16px rgba(80, 60, 120, 0.10);
    border: 2px solid #f3eafd;
    font-size: 1.1rem;
    transition: box-shadow 0.2s;
}

@media (max-width: 576px) {
    .hero-section-custom {
        padding-top: 1.2rem !important;
        align-items: center !important;
        text-align: center !important;
    }
    .hero-section-custom h1 {
        margin-top: 0.5rem !important;
        margin-bottom: 1.2rem !important;
        font-size: 2rem !important;
        line-height: 1.15;
        text-align: center !important;
        width: 100%;
        display: block;
    }
    .search-bar-section {
        margin-top: -10px !important;
        margin-bottom: 0 !important;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .search-bar-mobile {
        margin-left: auto !important;
        margin-right: auto !important;
        display: flex !important;
        justify-content: center;
        align-items: center;
    }
    .mt-5 {
        margin-top: 1.2rem !important;
    }
    .mb-4 {
        margin-bottom: 1.2rem !important;
    }
    .d-flex.justify-content-center {
        margin-bottom: 0.8rem !important;
    }
    /* Ajuste para el menú hamburguesa */
    .navbar-toggler {
        margin-right: 0.5rem !important;
        margin-left: 0.2rem !important;
    }
}
</style>
<style>
/* Forzar estilos de la barra de búsqueda avanzada con máxima especificidad */
.search-bar-elevated-custom input.form-control,
.search-bar-elevated-custom input.form-control:focus,
.search-bar-elevated-custom .form-control,
.search-bar-elevated-custom .form-control:focus {
    border: none !important;
    box-shadow: none !important;
    background: transparent !important;
    padding: 0.2rem 0.5rem !important;
    font-size: 1rem !important;
    min-height: 26px !important;
    height: 26px !important;
    border-radius: 0.7rem !important;
    outline: none !important;
    color: #222 !important;
}
.search-bar-elevated-custom .form-label {
    margin-bottom: 0.1rem !important;
    font-size: 0.93rem !important;
}
.search-bar-elevated-custom .vr {
    border-left: 1.5px solid #e0e0e0 !important;
    height: 100% !important;
    margin: 0 0.5rem !important;
    align-self: stretch !important;
}
.search-bar-elevated-custom input::placeholder {
    color: #b0b0b0 !important;
    font-size: 0.98rem !important;
    opacity: 1 !important;
}
.search-bar-elevated-custom {
    border: none !important;
    border-bottom: none !important;
    min-height: 38px !important;
    padding-top: 0.1rem !important;
    padding-bottom: 0.1rem !important;
    box-shadow: 0 4px 24px rgba(102, 126, 234, 0.10) !important;
}
</style>

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAn0n-nfpaAcvWeEWRg7iGIgNxC9X1FYHg&libraries=places&v=weekly" async defer></script>
<script src="https://unpkg.com/@googlemaps/places-autocomplete-element@latest/dist/index.min.js"></script>
<script>
const API_KEY = 'AIzaSyAn0n-nfpaAcvWeEWRg7iGIgNxC9X1FYHg';
function setupUbicacionAutocomplete(inputId, sugerenciasId, ciudadId, barrioId, latId, lonId) {
    const input = document.getElementById(inputId);
    const sugerenciasDiv = document.getElementById(sugerenciasId);
    const ciudadInput = document.getElementById(ciudadId);
    const barrioInput = document.getElementById(barrioId);
    const latInput = document.getElementById(latId);
    const lonInput = document.getElementById(lonId);
    let seleccionValida = false;
    let timeout = null;
    let placeIdSeleccionado = null;
    function limpiarCampos() {
        ciudadInput.value = '';
        barrioInput.value = '';
        latInput.value = '';
        lonInput.value = '';
        seleccionValida = false;
        placeIdSeleccionado = null;
    }
    async function buscarSugerencias(query) {
        if (!query || query.length < 3) {
            sugerenciasDiv.innerHTML = '';
            return;
        }
        const url = `https://places.googleapis.com/v1/places:autocomplete?key=${API_KEY}`;
        const body = {
            input: query,
            languageCode: 'es',
            regionCode: 'CO',
        };
        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (data.suggestions && data.suggestions.length > 0) {
                sugerenciasDiv.innerHTML = '';
                data.suggestions.forEach(sug => {
                    const pred = sug.placePrediction || sug;
                    let main = pred.structuredFormat && pred.structuredFormat.mainText ? pred.structuredFormat.mainText.text : '';
                    let city = pred.structuredFormat && pred.structuredFormat.secondaryText ? pred.structuredFormat.secondaryText.text : '';
                    let depto = '';
                    if (city && city.includes(',')) {
                        const parts = city.split(',');
                        city = parts[0].trim();
                        depto = parts.slice(1).join(',').trim();
                    }
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action px-3 py-3 text-start border-0';
                    item.style.cssText = 'transition: all 0.2s ease; border-bottom: 1px solid #f8f9fa;';
                    item.innerHTML = `
                        <div class='fw-bold text-dark mb-1' style='font-size: 0.95rem;'>${main}</div>
                        <div class='small text-muted mb-1' style='font-size: 0.85rem;'>${city}</div>
                        <div class='small text-muted' style='font-size: 0.8rem;'>${depto}</div>
                    `;
                    item.onmouseenter = function() {
                        this.style.backgroundColor = '#f8f9fa';
                        this.style.transform = 'translateX(2px)';
                    };
                    item.onmouseleave = function() {
                        this.style.backgroundColor = 'white';
                        this.style.transform = 'translateX(0)';
                    };
                    item.onclick = () => seleccionarSugerencia(pred, `${main}, ${city}${depto ? ', ' + depto : ''}`);
                    sugerenciasDiv.appendChild(item);
                });
            } else {
                sugerenciasDiv.innerHTML = '';
            }
        } catch (err) {
            sugerenciasDiv.innerHTML = '';
        }
    }
    async function seleccionarSugerencia(pred, textoMostrado) {
        sugerenciasDiv.innerHTML = '';
        let placeId = pred.placeId || (pred.place && pred.place.replace(/^places\//, '')) || null;
        let texto = textoMostrado;
        if (!placeId) {
            limpiarCampos();
            return;
        }
        input.value = texto;
        placeIdSeleccionado = placeId;
        // Obtener detalles del lugar
        const url = `https://places.googleapis.com/v1/places/${encodeURIComponent(placeId)}?key=${API_KEY}&languageCode=es`;
        try {
            const resp = await fetch(url);
            const data = await resp.json();
            let ciudad = '';
            let barrio = '';
            let lat = '';
            let lon = '';
            if (data.addressComponents) {
                data.addressComponents.forEach(function(component) {
                    if (component.types.includes('locality')) {
                        ciudad = component.longText;
                    }
                    if (component.types.includes('sublocality') || component.types.includes('neighborhood')) {
                        barrio = component.longText;
                    }
                });
            }
            if (data.location) {
                lat = data.location.latitude;
                lon = data.location.longitude;
            }
            ciudadInput.value = ciudad;
            barrioInput.value = barrio;
            latInput.value = lat;
            lonInput.value = lon;
            seleccionValida = true;
        } catch (err) {
            limpiarCampos();
        }
    }
    input.addEventListener('input', function() {
        limpiarCampos();
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => buscarSugerencias(input.value), 400);
    });
    document.addEventListener('click', function(e) {
        if (!sugerenciasDiv.contains(e.target) && e.target !== input) {
            sugerenciasDiv.innerHTML = '';
        }
    });
}
// Inicializar para desktop y mobile
setupUbicacionAutocomplete('ubicacion-autocomplete', 'sugerencias-ubicacion', 'ubicacion-ciudad', 'ubicacion-barrio', 'ubicacion-lat', 'ubicacion-lon');
setupUbicacionAutocomplete('ubicacion-autocomplete-mobile', 'sugerencias-ubicacion-mobile', 'ubicacion-ciudad-mobile', 'ubicacion-barrio-mobile', 'ubicacion-lat-mobile', 'ubicacion-lon-mobile');
// Autocompletado de servicios (desktop)
const servicioInput = document.getElementById('servicio-autocomplete');
const serviciosList = document.getElementById('servicios-list');
function fetchServiciosDesktop(query = '', lat = null, lon = null) {
    let url = `/clientes/api/autocompletar-servicios/?q=${encodeURIComponent(query)}`;
    if (lat && lon) {
        url += `&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    } else {
        const latField = document.getElementById('ubicacion-lat');
        const lonField = document.getElementById('ubicacion-lon');
        if (latField && lonField && latField.value && lonField.value) {
            url += `&lat=${encodeURIComponent(latField.value)}&lon=${encodeURIComponent(lonField.value)}`;
        }
    }
    fetch(url)
        .then(response => response.json())
        .then(data => {
            serviciosList.innerHTML = '';
            (data.servicios || []).forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio;
                serviciosList.appendChild(option);
            });
        });
}
if (servicioInput && serviciosList) {
    servicioInput.addEventListener('input', function() {
        fetchServiciosDesktop(servicioInput.value);
    });
    servicioInput.addEventListener('focus', function() {
        const latField = document.getElementById('ubicacion-lat');
        const lonField = document.getElementById('ubicacion-lon');
        if ((!latField || !latField.value) && (!lonField || !lonField.value)) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    fetch(`/clientes/api/negocios-cercanos/?lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                        .then(response => response.json())
                        .then(data => {
                            serviciosList.innerHTML = '';
                            let serviciosSet = new Set();
                            (data.negocios || []).forEach(negocio => {
                                (negocio.servicios || []).forEach(servicio => serviciosSet.add(servicio));
                            });
                            Array.from(serviciosSet).forEach(servicio => {
                                const option = document.createElement('option');
                                option.value = servicio;
                                serviciosList.appendChild(option);
                            });
                        });
                }, function() {
                    serviciosList.innerHTML = '';
                    const option = document.createElement('option');
                    option.value = 'Activa la ubicación para ver servicios cercanos';
                    serviciosList.appendChild(option);
                });
            } else {
                serviciosList.innerHTML = '';
                const option = document.createElement('option');
                option.value = 'Navegador sin soporte de ubicación';
                serviciosList.appendChild(option);
            }
        } else {
            fetchServiciosDesktop('');
        }
    });
}
// Autocompletado de servicios (mobile)
const servicioInputMobile = document.getElementById('servicio-autocomplete-mobile');
const serviciosListMobile = document.getElementById('servicios-list-mobile');
function fetchServiciosMobile(query = '') {
    const lat = document.getElementById('ubicacion-lat-mobile').value;
    const lon = document.getElementById('ubicacion-lon-mobile').value;
    let url = `/clientes/api/autocompletar-servicios/?q=${encodeURIComponent(query)}`;
    if (lat && lon) {
        url += `&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    }
    fetch(url)
        .then(response => response.json())
        .then(data => {
            serviciosListMobile.innerHTML = '';
            (data.servicios || []).forEach(servicio => {
                const option = document.createElement('option');
                option.value = servicio;
                serviciosListMobile.appendChild(option);
            });
        });
}
if (servicioInputMobile && serviciosListMobile) {
    servicioInputMobile.addEventListener('input', function() {
        fetchServiciosMobile(servicioInputMobile.value);
    });
    servicioInputMobile.addEventListener('focus', function() {
        fetchServiciosMobile('');
    });
}
// Mostrar negocios cercanos en dropdown visual al hacer focus en servicio
const negociosDropdown = document.getElementById('negocios-cercanos-dropdown');
const negocioInput = document.getElementById('negocio-autocomplete');
servicioInput.addEventListener('focus', function() {
    const latField = document.getElementById('ubicacion-lat');
    const lonField = document.getElementById('ubicacion-lon');
    if ((!latField || !latField.value) && (!lonField || !lonField.value)) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                fetch(`/clientes/api/negocios-cercanos/?lat=${position.coords.latitude}&lon=${position.coords.longitude}`)
                    .then(response => response.json())
                    .then(data => {
                        negociosDropdown.innerHTML = '';
                        if ((data.negocios || []).length > 0) {
                            negociosDropdown.classList.add('show');
                            (data.negocios || []).forEach(negocio => {
                                const item = document.createElement('button');
                                item.type = 'button';
                                item.className = 'dropdown-item d-flex justify-content-between align-items-center';
                                item.innerHTML = `<span>${negocio.nombre}</span><span class='badge bg-primary ms-2'>${Math.round(negocio.distancia)} m</span>`;
                                item.onclick = function() {
                                    negocioInput.value = negocio.nombre;
                                    negociosDropdown.classList.remove('show');
                                };
                                negociosDropdown.appendChild(item);
                            });
                        } else {
                            negociosDropdown.classList.remove('show');
                        }
                    });
            });
        }
    } else {
        negociosDropdown.classList.remove('show');
    }
});
// Ocultar dropdown si se hace click fuera
document.addEventListener('click', function(e) {
    if (!servicioInput.contains(e.target) && !negociosDropdown.contains(e.target)) {
        negociosDropdown.classList.remove('show');
    }
});
// Autocompletado de negocios
const negociosList = document.getElementById('negocios-list');
function fetchNegocios(query = '') {
    const lat = document.getElementById('ubicacion-lat').value;
    const lon = document.getElementById('ubicacion-lon').value;
    const servicio = document.getElementById('servicio-autocomplete').value;
    let url = `/clientes/api/autocompletar-negocios/?q=${encodeURIComponent(query)}`;
    if (lat && lon) {
        url += `&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    }
    if (servicio) {
        url += `&servicio=${encodeURIComponent(servicio)}`;
    }
    fetch(url)
        .then(response => response.json())
        .then(data => {
            negociosList.innerHTML = '';
            (data.negocios || []).forEach(negocio => {
                const option = document.createElement('option');
                option.value = negocio.nombre;
                negociosList.appendChild(option);
            });
        });
}
if (negocioInput && negociosList) {
    negocioInput.addEventListener('input', function() {
        fetchNegocios(negocioInput.value);
    });
    negocioInput.addEventListener('focus', function() {
        fetchNegocios('');
    });
}
// Autocompletado de negocios (mobile)
const negocioInputMobile = document.getElementById('negocio-autocomplete-mobile');
const negociosListMobile = document.getElementById('negocios-list-mobile');
function fetchNegociosMobile(query = '') {
    const lat = document.getElementById('ubicacion-lat-mobile').value;
    const lon = document.getElementById('ubicacion-lon-mobile').value;
    const servicio = document.getElementById('servicio-autocomplete-mobile').value;
    let url = `/clientes/api/autocompletar-negocios/?q=${encodeURIComponent(query)}`;
    if (lat && lon) {
        url += `&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    }
    if (servicio) {
        url += `&servicio=${encodeURIComponent(servicio)}`;
    }
    fetch(url)
        .then(response => response.json())
        .then(data => {
            negociosListMobile.innerHTML = '';
            (data.negocios || []).forEach(negocio => {
                const option = document.createElement('option');
                option.value = negocio.nombre;
                negociosListMobile.appendChild(option);
            });
        });
}
if (negocioInputMobile && negociosListMobile) {
    negocioInputMobile.addEventListener('input', function() {
        fetchNegociosMobile(negocioInputMobile.value);
    });
    negocioInputMobile.addEventListener('focus', function() {
        fetchNegociosMobile('');
    });
}
// Autocompletado para servicios
function setupServicioAutocomplete(inputId, sugerenciasId) {
    const input = document.getElementById(inputId);
    const sugerenciasDiv = document.getElementById(sugerenciasId);
    let timeout = null;
    
    async function buscarServicios(query) {
        if (!query || query.length < 2) {
            sugerenciasDiv.innerHTML = '';
            return;
        }
        
        try {
            const response = await fetch(`/clientes/api/autocompletar-servicios/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.sugerencias && data.sugerencias.length > 0) {
                sugerenciasDiv.innerHTML = '';
                data.sugerencias.forEach(servicio => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action px-3 py-3 text-start border-0';
                    item.style.cssText = 'transition: all 0.2s ease; border-bottom: 1px solid #f8f9fa;';
                    item.innerHTML = `<div class='fw-bold text-dark' style='font-size: 0.95rem;'>${servicio.nombre}</div>`;
                    item.onmouseenter = function() {
                        this.style.backgroundColor = '#f8f9fa';
                        this.style.transform = 'translateX(2px)';
                    };
                    item.onmouseleave = function() {
                        this.style.backgroundColor = 'white';
                        this.style.transform = 'translateX(0)';
                    };
                    item.onclick = () => {
                        input.value = servicio.nombre;
                        sugerenciasDiv.innerHTML = '';
                    };
                    sugerenciasDiv.appendChild(item);
                });
            } else {
                sugerenciasDiv.innerHTML = '';
            }
        } catch (err) {
            sugerenciasDiv.innerHTML = '';
        }
    }
    
    input.addEventListener('input', function() {
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => buscarServicios(input.value), 300);
    });
    
    document.addEventListener('click', function(e) {
        if (!sugerenciasDiv.contains(e.target) && e.target !== input) {
            sugerenciasDiv.innerHTML = '';
        }
    });
}

// Autocompletado para negocios
function setupNegocioAutocomplete(inputId, sugerenciasId) {
    const input = document.getElementById(inputId);
    const sugerenciasDiv = document.getElementById(sugerenciasId);
    let timeout = null;
    
    async function buscarNegocios(query) {
        if (!query || query.length < 2) {
            sugerenciasDiv.innerHTML = '';
            return;
        }
        
        try {
            const response = await fetch(`/clientes/api/autocompletar-negocios/?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            
            if (data.sugerencias && data.sugerencias.length > 0) {
                sugerenciasDiv.innerHTML = '';
                data.sugerencias.forEach(negocio => {
                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action px-3 py-3 text-start border-0';
                    item.style.cssText = 'transition: all 0.2s ease; border-bottom: 1px solid #f8f9fa;';
                    item.innerHTML = `
                        <div class='fw-bold text-dark mb-1' style='font-size: 0.95rem;'>${negocio.nombre}</div>
                        <div class='small text-muted' style='font-size: 0.85rem;'>${negocio.direccion}</div>
                    `;
                    item.onmouseenter = function() {
                        this.style.backgroundColor = '#f8f9fa';
                        this.style.transform = 'translateX(2px)';
                    };
                    item.onmouseleave = function() {
                        this.style.backgroundColor = 'white';
                        this.style.transform = 'translateX(0)';
                    };
                    item.onclick = () => {
                        input.value = negocio.nombre;
                        sugerenciasDiv.innerHTML = '';
                    };
                    sugerenciasDiv.appendChild(item);
                });
            } else {
                sugerenciasDiv.innerHTML = '';
            }
        } catch (err) {
            sugerenciasDiv.innerHTML = '';
        }
    }
    
    input.addEventListener('input', function() {
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => buscarNegocios(input.value), 300);
    });
    
    document.addEventListener('click', function(e) {
        if (!sugerenciasDiv.contains(e.target) && e.target !== input) {
            sugerenciasDiv.innerHTML = '';
        }
    });
}

// Inicializar autocompletados
setupServicioAutocomplete('servicio-autocomplete', 'sugerencias-servicio');
setupServicioAutocomplete('servicio-autocomplete-mobile', 'sugerencias-servicio-mobile');
setupNegocioAutocomplete('negocio-autocomplete', 'sugerencias-negocio');
setupNegocioAutocomplete('negocio-autocomplete-mobile', 'sugerencias-negocio-mobile');

// Búsqueda combinada y flexible
function buscarNegocios() {
    const ubicacionInput = document.getElementById('ubicacion-autocomplete');
    const lat = document.getElementById('ubicacion-lat').value;
    const lon = document.getElementById('ubicacion-lon').value;
    const servicio = document.getElementById('servicio-autocomplete').value;
    const negocio = document.getElementById('negocio-autocomplete').value;
    let url = '/clientes/buscar/?';
    if (ubicacionInput.value && lat && lon && !servicio && !negocio) {
        // Solo ubicación: buscar negocios a 500m
        url += `lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&radio=500`;
    } else {
        if (ubicacionInput.value && lat && lon) {
            url += `lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&`;
        } else if (ubicacionInput.value && (!lat || !lon)) {
            // Si no hay lat/lon, enviar ubicacion textual
            url += `ubicacion=${encodeURIComponent(ubicacionInput.value)}&`;
        }
        if (servicio) {
            url += `servicio=${encodeURIComponent(servicio)}&`;
        }
        if (negocio) {
            url += `negocio=${encodeURIComponent(negocio)}&`;
        }
    }
    window.location.href = url;
}
// Asignar búsqueda al botón
const btnBuscar = document.querySelector('.search-bar-elevated-custom .btn-pink');
if (btnBuscar) {
    btnBuscar.addEventListener('click', buscarNegocios);
}

function buscarNegociosMobile() {
    const ubicacionInput = document.getElementById('ubicacion-autocomplete-mobile');
    const lat = document.getElementById('ubicacion-lat-mobile').value;
    const lon = document.getElementById('ubicacion-lon-mobile').value;
    const servicio = document.getElementById('servicio-autocomplete-mobile').value;
    const negocio = document.getElementById('negocio-autocomplete-mobile').value;
    let url = '/clientes/buscar/?';
    if (ubicacionInput.value && lat && lon && !servicio && !negocio) {
        url += `lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&radio=500`;
    } else {
        if (ubicacionInput.value && lat && lon) {
            url += `lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&`;
        } else if (ubicacionInput.value && (!lat || !lon)) {
            url += `ubicacion=${encodeURIComponent(ubicacionInput.value)}&`;
        }
        if (servicio) {
            url += `servicio=${encodeURIComponent(servicio)}&`;
        }
        if (negocio) {
            url += `negocio=${encodeURIComponent(negocio)}&`;
        }
    }
    window.location.href = url;
}
// Asignar búsqueda al botón mobile
const btnBuscarMobile = document.querySelector('#busquedaModal .btn-pink');
if (btnBuscarMobile) {
    btnBuscarMobile.addEventListener('click', buscarNegociosMobile);
}
</script>
{% endblock %}
{% endblock %} 